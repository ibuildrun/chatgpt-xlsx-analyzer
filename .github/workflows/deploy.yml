name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 10

      - name: Get commit info
        id: commit
        run: |
          echo "message=$(git log -1 --pretty=%s | head -c 100)" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build better-sqlite3 for Linux (GLIBC 2.28 compatible)
        run: |
          mkdir -p sqlite-build-output
          docker build -t better-sqlite3-builder -f build-sqlite.dockerfile .
          docker run --rm -v $(pwd)/sqlite-build-output:/output better-sqlite3-builder
          rm -rf node_modules/better-sqlite3
          tar -xzf sqlite-build-output/better-sqlite3-linux.tar.gz -C node_modules/
          file node_modules/better-sqlite3/build/Release/better_sqlite3.node

      - name: Create example XLSX
        run: npm run setup:xlsx

      - name: Build application
        run: npm run build

      - name: Fix better-sqlite3 in .next/node_modules
        run: |
          for dir in .next/node_modules/better-sqlite3-*; do
            if [ -d "$dir" ]; then
              SRC="node_modules/better-sqlite3/build/Release/better_sqlite3.node"
              DST="$dir/build/Release/better_sqlite3.node"
              if [ ! "$SRC" -ef "$DST" ]; then
                echo "Fixing binary in $dir"
                cp "$SRC" "$DST"
                file "$DST"
              else
                echo "Binary already correct in $dir"
              fi
            fi
          done

      - name: Prepare deployment files
        run: |
          mkdir -p deploy-package
          cp -r .next deploy-package/
          cp -r public deploy-package/
          cp -r data deploy-package/
          cp package.json deploy-package/
          cp next.config.mjs deploy-package/
          cp index.php deploy-package/
          cp .htaccess deploy-package/
          mkdir -p deploy-package/node_modules
          cp -r node_modules/better-sqlite3 deploy-package/node_modules/
          cp -r .next/static deploy-package/_next
          mkdir -p deploy-package/scripts
          cp scripts/healthcheck.sh deploy-package/scripts/
          
          echo "=== Deployment package contents ==="
          du -sh deploy-package/*
          
          tar -czf deploy-package.tar.gz -C deploy-package .
          ls -lh deploy-package.tar.gz

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-package
          path: deploy-package.tar.gz
          retention-days: 7

      - name: Deploy files via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: "deploy-package.tar.gz"
          target: "/var/www/u3370847/data/www/ai.ibuildrun.ru/"
          overwrite: true

      - name: Extract and restart via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            cd /var/www/u3370847/data/www/ai.ibuildrun.ru
            
            # Backup current version
            if [ -d ".next.backup" ]; then rm -rf .next.backup; fi
            if [ -d ".next" ]; then mv .next .next.backup; fi
            
            # Extract new version
            tar -xzf deploy-package.tar.gz
            rm deploy-package.tar.gz
            
            # Set permissions
            chmod -R 755 _next
            chmod +x scripts/healthcheck.sh
            
            # Restart PM2 using direct path
            PM2="/var/www/u3370847/data/.nvm/versions/node/v20.19.6/bin/pm2"
            $PM2 restart ai-chat || $PM2 start npm --name "ai-chat" -- start
            $PM2 save
            
            echo "Deployment complete!"

      - name: Health Check
        run: |
          echo "Waiting for deployment to settle..."
          sleep 10
          
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://ai.ibuildrun.ru || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Health check passed: HTTP $HTTP_STATUS"
          else
            echo "Health check warning: HTTP $HTTP_STATUS (may still be starting)"
          fi

      - name: Deployment status
        if: always()
        run: |
          echo "============================================"
          echo "DEPLOYMENT STATUS"
          echo "============================================"
          echo "Commit: ${{ steps.commit.outputs.short_sha }}"
          echo "Message: ${{ steps.commit.outputs.message }}"
          echo "Site: https://ai.ibuildrun.ru"
          echo "============================================"
