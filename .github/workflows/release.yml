name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3"

      - name: Install dependencies
        run: bun install

      - name: Build
        run: bun run build

      - name: Semantic Release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bunx semantic-release

  deploy-regru:
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Reg.ru
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REGRU_HOST }}
          username: ${{ secrets.REGRU_USER }}
          key: ${{ secrets.REGRU_SSH_KEY }}
          port: ${{ secrets.REGRU_PORT }}
          script: |
            cd ${{ secrets.REGRU_APP_PATH }}
            git fetch origin main
            git reset --hard origin/main
            
            # Install Bun if not exists
            if ! command -v bun &> /dev/null; then
              curl -fsSL https://bun.sh/install | bash
              export BUN_INSTALL="$HOME/.bun"
              export PATH="$BUN_INSTALL/bin:$PATH"
            fi
            
            bun install --production
            bun run build
            
            # Restart with PM2
            pm2 restart chatgpt-xlsx-analyzer 2>/dev/null || pm2 start bun --name chatgpt-xlsx-analyzer -- run start
            pm2 save
